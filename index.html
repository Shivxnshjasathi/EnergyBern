<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Energy Player - Recently Played</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    body {font-family: 'Inter', sans-serif;}
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 8px; }
    ::-webkit-scrollbar-thumb:hover { background: #4b5563; }

    /* Playing bars animation */
    .playing-indicator {
      width: 18px; height: 18px;
      display: flex; justify-content: space-around; align-items: flex-end;
    }
    .playing-indicator span {
      width: 3px; height: 100%;
      background-color: #10B981; border-radius: 2px;
      animation: bounce 1.4s ease-in-out infinite;
    }
    .playing-indicator span:nth-of-type(2) { animation-delay: -1s; }
    .playing-indicator span:nth-of-type(3) { animation-delay: -0.5s; }
    @keyframes bounce {
      0%, 100% { transform: scaleY(.2); }
      50% { transform: scaleY(1); }
    }
    /* Style for the active channel button */
    .active-channel {
        background-image: linear-gradient(to right, var(--tw-gradient-stops));
        --tw-gradient-from: #22c55e;
        --tw-gradient-to: #3b82f6;
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to);
        color: white;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    /* Full-screen details page styles */
    .details-screen {
        transition: opacity 0.3s ease-in-out;
    }
    .details-content {
        transition: transform 0.3s ease-in-out;
    }
    body.modal-open {
        overflow: hidden;
    }
  </style>
</head>
<body class="bg-gradient-to-b from-gray-900 via-gray-800 to-black text-white antialiased">

  <!-- Main Container -->
  <div id="main-content" class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="p-6 text-center">
      <h1 class="text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-500 drop-shadow-md">
        üé∂ Energy Player
      </h1>
      <p class="mt-2 text-gray-400 text-lg">Your Recently Played Songs</p>
      
      <!-- Channel Selector Carousel -->
      <div id="channel-selector" class="mt-8 flex justify-center items-center flex-wrap gap-2 sm:gap-4">
        <button data-channel="bern" class="channel-btn py-2 px-5 rounded-full text-sm font-semibold transition active-channel">Bern</button>
        <button data-channel="basel" class="channel-btn py-2 px-5 rounded-full text-sm font-semibold text-gray-400 bg-gray-800 hover:bg-gray-700 hover:text-white transition">Basel</button>
        <button data-channel="luzern" class="channel-btn py-2 px-5 rounded-full text-sm font-semibold text-gray-400 bg-gray-800 hover:bg-gray-700 hover:text-white transition">Lucerne</button>
      </div>

      <!-- Reload button -->
      <div class="mt-6">
        <button id="reload-button"
          class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 
                 disabled:from-gray-600 disabled:to-gray-600 disabled:cursor-not-allowed 
                 text-white font-semibold py-2 px-6 rounded-full shadow-lg flex items-center gap-2 transition">
          <svg id="reload-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.695v-2.257a4.5 4.5 0 00-4.5-4.5H10.5a4.5 4.5 0 00-4.5 4.5v2.257m12.75 0h-4.992" />
          </svg>
          <span id="reload-text">Reload Playlist</span>
        </button>
      </div>
    </header>

    <!-- Songs List -->
    <main id="song-list" class="flex-1 px-6 pb-28 max-w-4xl w-full mx-auto space-y-4 overflow-y-auto">
      <!-- Loading -->
      <div id="loading" class="flex justify-center items-center h-64">
        <div class="h-16 w-16 border-t-4 border-b-4 border-green-400 rounded-full animate-spin"></div>
      </div>
      <!-- Songs injected here -->
    </main>

    <!-- Fixed Bottom Player Bar -->
    <div id="player-bar" class="fixed bottom-0 inset-x-0 bg-black/80 backdrop-blur-md border-t border-gray-800 p-4 hidden">
      <div class="flex items-center justify-between max-w-5xl mx-auto">
        <div id="player-info" class="flex items-center space-x-3">
          <img id="player-img" src="" alt="" class="w-12 h-12 rounded-lg object-cover shadow-md">
          <div>
            <h2 id="player-title" class="text-white font-semibold text-sm truncate w-40 capitalize"></h2>
            <p id="player-artist" class="text-gray-400 text-xs truncate w-40 capitalize"></p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <button id="play-pause" class="p-3 rounded-full bg-green-500 hover:bg-green-600 transition">
            ‚ñ∂Ô∏è
          </button>
        </div>
      </div>
    </div>

    <!-- Hidden audio element -->
    <audio id="audio-player" class="hidden"></audio>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
      <p>Powered by Energy.ch API üéµ | Designed for a smooth music experience</p>
    </footer>
  </div>

  <!-- **NEW**: Full-screen Gemini Details Page -->
  <div id="details-screen" class="details-screen fixed inset-0 bg-gray-900/90 backdrop-blur-lg z-50 hidden opacity-0 overflow-y-auto">
      <div class="details-content container mx-auto p-4 sm:p-8 max-w-4xl text-white transform translate-y-8">
          <button id="close-details-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
          </button>
          
          <div class="flex flex-col md:flex-row gap-8">
              <div class="md:w-1/3 text-center">
                  <img id="details-img" src="" class="w-full rounded-2xl shadow-2xl mb-4">
                  <h2 id="details-title" class="text-3xl font-bold capitalize"></h2>
                  <p id="details-artist" class="text-lg text-gray-400 capitalize mb-4"></p>
                  <button id="details-play-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-full flex items-center justify-center gap-2 w-full">
                      <span id="details-play-icon">‚ñ∂Ô∏è</span> Play Preview
                  </button>
              </div>
              <div class="md:w-2/3 space-y-6">
                  <div>
                      <h3 class="text-2xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">‚ú® Fun Fact</h3>
                      <p id="details-fact" class="text-gray-300 min-h-[50px]"></p>
                  </div>
                  <div>
                      <h3 class="text-2xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">üéµ Lyrics</h3>
                      <pre id="details-lyrics" class="text-gray-300 whitespace-pre-wrap font-sans bg-gray-800/50 p-4 rounded-lg max-h-60 overflow-y-auto"></pre>
                  </div>
                  <div>
                      <h3 class="text-2xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">üéß Listen On</h3>
                      <div id="details-links" class="flex flex-wrap gap-4"></div>
                  </div>
              </div>
          </div>
      </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const mainContent = document.getElementById('main-content');
  const songList = document.getElementById('song-list');
  const loadingIndicator = document.getElementById('loading');
  const audioPlayer = document.getElementById('audio-player');
  const reloadButton = document.getElementById('reload-button');
  const reloadIcon = document.getElementById('reload-icon');
  const reloadText = document.getElementById('reload-text');
  const playerBar = document.getElementById('player-bar');
  const playerTitle = document.getElementById('player-title');
  const playerArtist = document.getElementById('player-artist');
  const playerImg = document.getElementById('player-img');
  const playPauseBtn = document.getElementById('play-pause');
  const channelSelector = document.getElementById('channel-selector');
  
  // Details Screen elements
  const detailsScreen = document.getElementById('details-screen');
  const closeDetailsBtn = document.getElementById('close-details-btn');
  const detailsImg = document.getElementById('details-img');
  const detailsTitle = document.getElementById('details-title');
  const detailsArtist = document.getElementById('details-artist');
  const detailsPlayBtn = document.getElementById('details-play-btn');
  const detailsPlayIcon = document.getElementById('details-play-icon');
  const detailsFact = document.getElementById('details-fact');
  const detailsLyrics = document.getElementById('details-lyrics');
  const detailsLinks = document.getElementById('details-links');


  const proxyUrls = [ 
      'https://corsproxy.io/?', 
      'https://api.allorigins.win/raw?url=',
      'https://thingproxy.freeboard.io/fetch/'
  ];
  let currentProxyIndex = 0;
  let currentlyPlayingCard = null;
  let currentChannel = 'bern';

  // --- Gemini API Function ---
  // **MODIFIED**: Updated to fetch structured data (lyrics, links, fact).
  async function getSongDetails(title, artist) {
      const prompt = `For the song "${title}" by "${artist}", provide the following information in a JSON object: the full lyrics, a fun fact (under 40 words), and streaming links for YouTube, Spotify, and Apple Music.`;
      const apiKey = "AIzaSyBwNywxcIhAk8t-xC_9yDLRCBuA9ZOPm88"; // API key will be provided by the environment
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
      
      const payload = {
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                  type: "OBJECT",
                  properties: {
                      "lyrics": { "type": "STRING" },
                      "funFact": { "type": "STRING" },
                      "streamingLinks": {
                          "type": "OBJECT",
                          "properties": {
                              "youtube": { "type": "STRING" },
                              "spotify": { "type": "STRING" },
                              "appleMusic": { "type": "STRING" }
                          }
                      }
                  }
              }
          }
      };

      try {
          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });
          if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
          const result = await response.json();
          const jsonText = result.candidates[0].content.parts[0].text;
          return JSON.parse(jsonText);
      } catch (error) {
          console.error("Gemini API call failed:", error);
          return {
              lyrics: "Sorry, lyrics could not be fetched at this time.",
              funFact: "Could not fetch a fun fact right now. Please try again later.",
              streamingLinks: {}
          };
      }
  }


  // A core function for a single fetch attempt.
  async function performFetchAttempt() {
    const apiUrl = `https://energy.ch/api/channels/${currentChannel}/playouts`;
    const proxyBase = proxyUrls[currentProxyIndex];
    let proxyUrl = proxyBase.includes('allorigins') ? `${proxyBase}${encodeURIComponent(apiUrl)}` : `${proxyBase}${apiUrl}`;
    
    try {
      const response = await fetch(proxyUrl);
      if(!response.ok) throw new Error(`HTTP Status: ${response.status}`);
      return await response.json();
    } catch(e) {
      console.error(`Fetch attempt failed with proxy ${currentProxyIndex}:`, e.message);
      currentProxyIndex = (currentProxyIndex + 1) % proxyUrls.length;
      return null;
    }
  }

  // Function to handle the initial load.
  async function initialLoad() {
    let songs = null;
    while (!songs || songs.length === 0) {
      songs = await performFetchAttempt();
      if (!songs || songs.length === 0) await new Promise(resolve => setTimeout(resolve, 5000));
    }
    loadingIndicator.style.display = "none";
    displaySongs(songs);
  }
  
  // Function for manual reloads and interval updates.
  async function fetchSongs() {
    if (reloadButton.disabled) return;
    reloadButton.disabled = true;
    reloadText.textContent = 'Loading...';
    reloadIcon.classList.add('animate-spin');
    const songs = await performFetchAttempt();
    if (songs) displaySongs(songs);
    reloadButton.disabled = false;
    reloadText.textContent = 'Reload Playlist';
    reloadIcon.classList.remove('animate-spin');
  }

  function displaySongs(songs){
    const currentAudioUrl = currentlyPlayingCard ? currentlyPlayingCard.dataset.audioUrl : null;
    const isPlaying = !audioPlayer.paused && currentAudioUrl;
    songList.innerHTML = '';
    currentlyPlayingCard = null;

    songs.forEach(song => {
      const card = document.createElement('div');
      card.className = 'song-card-container';
      card.innerHTML = `
        <div class="song-card group bg-gray-800/60 rounded-xl p-4 flex items-center space-x-4 shadow-md hover:shadow-lg hover:bg-gray-700/80 cursor-pointer transition duration-300"
             data-audio-url="${song.audioUrl}">
          <img src="${song.imageUrl}" onerror="this.src='https://placehold.co/80x80?text=M';"
               class="song-img w-16 h-16 rounded-lg object-cover shadow-sm"/>
          <div class="flex-1 min-w-0">
            <h3 class="song-title text-white font-semibold truncate capitalize">${song.title}</h3>
            <p class="song-artist text-sm text-gray-400 truncate capitalize">${song.artist}</p>
            <p class="text-xs text-gray-500">${formatPlayTime(song.playFrom)}</p>
          </div>
          <div class="flex items-center space-x-2">
            <button class="details-btn p-2 rounded-full hover:bg-gray-600 transition" title="Get song details">‚ú®</button>
            <div class="play-icon text-gray-400 group-hover:text-green-400">‚ñ∂Ô∏è</div>
            <div class="playing-indicator hidden"><span></span><span></span><span></span></div>
          </div>
        </div>
      `;
      songList.appendChild(card);
      const songCardElement = card.querySelector('.song-card');
      if (isPlaying && song.audioUrl === currentAudioUrl) {
          currentlyPlayingCard = songCardElement;
      }
    });

    if (currentlyPlayingCard) updateUI(true);
  }

  function formatPlayTime(str){
    const d=new Date(str);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  // Combined event listener for play and details
  songList.addEventListener('click', async (e) => {
    const detailsButton = e.target.closest('.details-btn');
    const card = e.target.closest('.song-card');

    if (detailsButton) {
        showDetailsScreen(card);
    } else if (card) {
        playSongFromCard(card);
    }
  });
  
  async function playSongFromCard(card) {
      const url = card.dataset.audioUrl;
      if (currentlyPlayingCard === card && !audioPlayer.paused) {
          audioPlayer.pause();
          return;
      }
      try {
          currentlyPlayingCard = card;
          updatePlayerBar(card);
          if (audioPlayer.src !== url) audioPlayer.src = url;
          await audioPlayer.play();
      } catch (error) {
          if (error.name !== 'AbortError') console.error("Error playing audio:", error);
      }
  }

  // --- Details Screen Functions ---
  async function showDetailsScreen(card) {
      document.body.classList.add('modal-open');
      detailsScreen.classList.remove('hidden');
      setTimeout(() => {
          detailsScreen.classList.remove('opacity-0');
          detailsScreen.querySelector('.details-content').classList.remove('translate-y-8');
      }, 10);
      
      // Populate initial info
      const title = card.querySelector('.song-title').textContent;
      const artist = card.querySelector('.song-artist').textContent;
      detailsImg.src = card.querySelector('.song-img').src;
      detailsTitle.textContent = title;
      detailsArtist.textContent = artist;
      
      // Set loading states
      const loadingHTML = `<div class="animate-spin rounded-full h-6 w-6 border-t-2 border-b-2 border-green-400"></div>`;
      detailsFact.innerHTML = loadingHTML;
      detailsLyrics.innerHTML = loadingHTML;
      detailsLinks.innerHTML = loadingHTML;

      // Fetch from Gemini and populate
      const details = await getSongDetails(title, artist);
      detailsFact.textContent = details.funFact;
      detailsLyrics.textContent = details.lyrics;
      
      detailsLinks.innerHTML = '';
      for (const [platform, url] of Object.entries(details.streamingLinks)) {
          if (url) {
              const link = document.createElement('a');
              link.href = url;
              link.target = '_blank';
              link.className = 'bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full text-sm capitalize';
              link.textContent = platform.replace('Music', ' Music');
              detailsLinks.appendChild(link);
          }
      }
      if (detailsLinks.innerHTML === '') {
          detailsLinks.innerHTML = `<p class="text-gray-400">No streaming links found.</p>`;
      }
  }

  function hideDetailsScreen() {
      document.body.classList.remove('modal-open');
      detailsScreen.classList.add('opacity-0');
      detailsScreen.querySelector('.details-content').classList.add('translate-y-8');
      setTimeout(() => detailsScreen.classList.add('hidden'), 300);
  }

  closeDetailsBtn.addEventListener('click', hideDetailsScreen);
  detailsPlayBtn.addEventListener('click', () => {
      if (currentlyPlayingCard) playSongFromCard(currentlyPlayingCard);
  });


  playPauseBtn.addEventListener('click', ()=>{
    if(audioPlayer.paused){ audioPlayer.play(); } else { audioPlayer.pause(); }
  });

  audioPlayer.addEventListener('play', ()=> updateUI(true));
  audioPlayer.addEventListener('pause', ()=> updateUI(false));
  audioPlayer.addEventListener('ended', ()=>{ updateUI(false); currentlyPlayingCard=null; });

  function updateUI(isPlaying){
    document.querySelectorAll('.song-card').forEach(c=>{
      c.querySelector('.play-icon').classList.remove('hidden');
      c.querySelector('.playing-indicator').classList.add('hidden');
      c.classList.remove('ring-2','ring-green-500');
    });
    if(currentlyPlayingCard && isPlaying){
      currentlyPlayingCard.querySelector('.play-icon').classList.add('hidden');
      currentlyPlayingCard.querySelector('.playing-indicator').classList.remove('hidden');
      currentlyPlayingCard.classList.add('ring-2','ring-green-500');
      playPauseBtn.textContent='‚è∏';
      detailsPlayIcon.textContent='‚è∏';
    } else {
      playPauseBtn.textContent='‚ñ∂Ô∏è';
      detailsPlayIcon.textContent='‚ñ∂Ô∏è';
    }
  }

  function updatePlayerBar(card){
    playerBar.classList.remove('hidden');
    playerTitle.textContent = card.querySelector('h3').textContent;
    playerArtist.textContent = card.querySelector('p').textContent;
    playerImg.src = card.querySelector('img').src;
  }

  channelSelector.addEventListener('click', (e) => {
    const button = e.target.closest('.channel-btn');
    if (!button || button.classList.contains('active-channel')) return;
    currentChannel = button.dataset.channel;
    document.querySelectorAll('.channel-btn').forEach(btn => {
        btn.classList.remove('active-channel');
        btn.classList.add('bg-gray-800', 'text-gray-400');
    });
    button.classList.add('active-channel');
    button.classList.remove('bg-gray-800', 'text-gray-400');
    songList.innerHTML = '';
    loadingIndicator.style.display = 'flex';
    playerBar.classList.add('hidden');
    audioPlayer.pause();
    audioPlayer.src = '';
    currentlyPlayingCard = null;
    fetchSongs();
  });

  reloadButton.addEventListener('click', fetchSongs);
  initialLoad();
  setInterval(fetchSongs, 300000);
});
</script>
</body>
</html>
